<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Day — Advent</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    main{ padding:28px; max-width:760px; margin:40px auto; background: rgba(255,255,255,0.85); border-radius:12px; }
    .back{ display:inline-block; margin-bottom:12px; text-decoration:none; color:var(--ink); font-weight:700; }
    h2{ margin-top:0; color:var(--lesbian-5); }
    .content{ white-space:pre-wrap; line-height:1.6; color:var(--ink); }
    .door-music{ margin-top:24px; display:flex; flex-direction:column; align-items:center; }
    .door-music audio{ width:100%; max-width:340px; border:none; border-radius:999px; background: rgba(255,255,255,0.9); box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
  </style>
</head>
<body>
  <header>
    <h1>Advent Calendar</h1>
    <p>Behind each door is a translated poem, essay, or thought.</p>
  </header>
  <main>
    <a class="back" href="../index.html">&larr; Back to calendar</a>
    <h2 id="day-title">Day</h2>
    <div id="day-content" class="content">Loading…</div>
    <div id="door-audio" class="door-music" role="presentation"></div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" integrity="sha256-RZc2yGuxhLRVb18Nuziue4ZKtpybxFbH+5Dn5xK6LyY=" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Initialize snowfall
    function initializeSnowfall() {
      const snowContainer = document.createElement('div');
      snowContainer.className = 'snow-container';
      document.body.appendChild(snowContainer);

      function createSnowflake() {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.style.left = Math.random() * window.innerWidth + 'px';
        const size = 2 + Math.random() * 3;
        snowflake.style.width = size + 'px';
        snowflake.style.height = size + 'px';
        const duration = 12 + Math.random() * 10;
        snowflake.style.animationDuration = duration + 's';
        snowflake.style.animationDelay = Math.random() * 2 + 's';
        snowContainer.appendChild(snowflake);

        setTimeout(() => snowflake.remove(), (duration + 2) * 1000);
      }

      // Create snowflakes continuously
      setInterval(createSnowflake, 200);
      // Initial burst of snowflakes
      for (let i = 0; i < 30; i++) {
        setTimeout(createSnowflake, i * 80);
      }
    }

    // Start snowfall on page load
    initializeSnowfall();

    // read `d` query param, default to 01
    function getParam(name){
      try{ return new URLSearchParams(location.search).get(name); }catch(e){return null}
    }
    const rawDay = getParam('d');
    const sanitizedDay = (() => {
      const candidate = (rawDay || '').trim();
      if(/^[0-9]{1,2}$/.test(candidate)){
        return candidate.padStart(2,'0');
      }
      return '01';
    })();
    const dayNumber = Number(sanitizedDay);
    const titleEl = document.getElementById('day-title');
    const contentEl = document.getElementById('day-content');
    const panelAudio = document.getElementById('door-audio');

    const doorMusicMap = {
      '09': {
        src: '../audio/Mitski - Im Your Man (Official Lyric Video).mp3',
        name: 'Mitski — I’m Your Man (Official Lyric Video)'
      }
    };

    function renderDoorAudio(day) {
      if(!panelAudio) return;
      panelAudio.innerHTML = '';
      const info = doorMusicMap[day];
      if(!info) return;
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.autoplay = true;
      audio.loop = true;
      audio.preload = 'auto';
      audio.volume = 0.5;
      audio.setAttribute('aria-label', `${info.name} background music`);
      const source = document.createElement('source');
      source.src = info.src;
      source.type = 'audio/mpeg';
      audio.appendChild(source);
      panelAudio.appendChild(audio);

      const tryPlay = () => audio.play().catch(() => {
        const resume = () => {
          audio.play().catch(() => {});
          window.removeEventListener('pointerdown', resume);
        };
        window.addEventListener('pointerdown', resume, { once: true });
      });
      tryPlay();
    }

    titleEl.textContent = Number.isFinite(dayNumber) ? `Day ${dayNumber}` : 'Day';

    fetch(`../content/days/${sanitizedDay}.md`).then(r=>{
      if(!r.ok) throw new Error('Not found');
      return r.text();
    }).then(md=>{
      // render with marked if available, otherwise show raw
      if(typeof marked === 'function'){
        contentEl.innerHTML = marked(md);
      }else{
        // very small markdown-ish fallback: convert headers and line breaks
        const html = md.replace(/^### (.*$)/gim, '<h3>$1</h3>')
                       .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                       .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                       .replace(/\n\n+/g, '</p><p>')
                       .replace(/\n/g, '<br>');
        contentEl.innerHTML = '<p>' + html + '</p>';
      }
      renderDoorAudio(sanitizedDay);
    }).catch(err=>{
      contentEl.textContent = 'Unable to load content for this day.';
      console.error(err);
    });
  </script>
</body>
</html>